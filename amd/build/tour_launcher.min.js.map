{"version":3,"file":"tour_launcher.min.js","sources":["../src/tour_launcher.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tour launcher for the adaptive course audit plugin.\n *\n * Detects the `startacatour` URL parameter and starts the specified tour\n * programmatically, bypassing the normal Moodle tour matching which only\n * starts the first matching tour per page.\n *\n * Delegates to tool_usertours/usertours init() so that all event handling\n * (markStepShown, markTourComplete, reset link, resize) is handled by\n * Moodle core.\n *\n * @module     local_adaptive_course_audit/tour_launcher\n * @copyright  2026 Moodle HQ\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport {init as usertourInit} from 'tool_usertours/usertours';\n\n/**\n * Extract and remove the startacatour parameter from the URL.\n *\n * @returns {number|null} The tour ID, or null if not present.\n */\nconst extractTourIdFromUrl = () => {\n    const urlParams = new URLSearchParams(window.location.search);\n    const raw = urlParams.get('startacatour');\n    if (!raw) {\n        return null;\n    }\n\n    const parsed = parseInt(raw, 10);\n    if (isNaN(parsed) || parsed <= 0) {\n        return null;\n    }\n\n    // Remove the parameter from the address bar without reloading.\n    urlParams.delete('startacatour');\n    const search = urlParams.toString();\n    const cleaned = window.location.pathname + (search ? '?' + search : '') + window.location.hash;\n    window.history.replaceState(null, '', cleaned);\n\n    return parsed;\n};\n\n/**\n * Entry point: detect URL parameter and launch tour after a short delay.\n * @param {number} continueTour Optional tour ID to continue after completing the current one (for subtours).\n */\nexport const init = (continueTour = 0) => {\n    let id = extractTourIdFromUrl();\n    if (!id) {\n        if (continueTour == 0) {\n        return;\n        }\n        id = continueTour;\n    }\n\n    const isModEdit = window.location.pathname.indexOf('/course/modedit.php') !== -1;\n\n    const startTour = () => {\n        try {\n            // On modedit.php, expand the relevant collapsible sections after the tour has started,\n            // then trigger a few resizes so tool_usertours recalculates placement.\n            if (isModEdit && typeof window.require === 'function') {\n                window.setTimeout(() => {\n                    window.require(['local_adaptive_course_audit/modedit_expander'], (expander) => {\n                        try {\n                            if (expander && typeof expander.init === 'function') {\n                                expander.init();\n                            }\n                        } catch (error) {\n                            window.console.error('[ACA tour_launcher] Expander error', error);\n                        }\n                    });\n                }, 1500);\n            }\n\n            usertourInit([{tourId: id, startTour: true, filtervalues: {cssselector: []}}], ['tool_usertours/filter_cssselector']);\n        } catch (error) {\n            // If this fails, the usertour backdrop can appear without a step.\n            window.console.error('[ACA tour_launcher] Failed to start tour', error);\n        }\n    };\n\n    // Short delay so the normal Moodle bootstrap can run first;\n    // usertourInit() will end any competing tour before starting ours.\n    window.setTimeout(startTour, 500);\n};\n"],"names":["extractTourIdFromUrl","urlParams","URLSearchParams","window","location","search","raw","get","parsed","parseInt","isNaN","delete","toString","cleaned","pathname","hash","history","replaceState","continueTour","id","isModEdit","indexOf","startTour","require","setTimeout","expander","init","error","console","tourId","filtervalues","cssselector"],"mappings":";;;;;;;;;;;;;;;;MAqCMA,qBAAuB,WACnBC,UAAY,IAAIC,gBAAgBC,OAAOC,SAASC,QAChDC,IAAML,UAAUM,IAAI,oBACrBD,WACM,WAGLE,OAASC,SAASH,IAAK,OACzBI,MAAMF,SAAWA,QAAU,SACpB,KAIXP,UAAUU,OAAO,sBACXN,OAASJ,UAAUW,WACnBC,QAAUV,OAAOC,SAASU,UAAYT,OAAS,IAAMA,OAAS,IAAMF,OAAOC,SAASW,YAC1FZ,OAAOa,QAAQC,aAAa,KAAM,GAAIJ,SAE/BL,sBAOS,eAACU,oEAAe,EAC5BC,GAAKnB,2BACJmB,GAAI,IACe,GAAhBD,oBAGJC,GAAKD,mBAGHE,WAAyE,IAA7DjB,OAAOC,SAASU,SAASO,QAAQ,uBAE7CC,UAAY,SAINF,WAAuC,mBAAnBjB,OAAOoB,SAC3BpB,OAAOqB,YAAW,KACdrB,OAAOoB,QAAQ,CAAC,iDAAkDE,eAEtDA,UAAqC,mBAAlBA,SAASC,MAC5BD,SAASC,OAEf,MAAOC,OACLxB,OAAOyB,QAAQD,MAAM,qCAAsCA,aAGpE,0BAGM,CAAC,CAACE,OAAQV,GAAIG,WAAW,EAAMQ,aAAc,CAACC,YAAa,MAAO,CAAC,sCAClF,MAAOJ,OAELxB,OAAOyB,QAAQD,MAAM,2CAA4CA,SAMzExB,OAAOqB,WAAWF,UAAW"}