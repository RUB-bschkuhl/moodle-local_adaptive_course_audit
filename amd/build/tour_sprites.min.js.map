{"version":3,"file":"tour_sprites.min.js","sources":["../src/tour_sprites.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Add animated cat sprites to adaptive tour steps.\n *\n * @module     local_adaptive_course_audit/tour_sprites\n * @copyright  2025 Moodle HQ\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/config'], function($, coreConfig) {\n    'use strict';\n\n    const STEP_CONTAINER_SELECTOR = '[data-flexitour=\"container\"] .modal-content';\n    const CLASS_APPLIED = 'local-aca-tour-animated';\n    const SPRITE_CLASS = 'local-aca-tour-sprite';\n\n    /**\n     * Determine whether a node is a step container.\n     *\n     * @param {HTMLElement} node\n     * @returns {boolean}\n     */\n    const isStepContainer = node => {\n        return node instanceof HTMLElement && node.matches(STEP_CONTAINER_SELECTOR);\n    };\n\n    /**\n     * Apply the animated sprite to the tour step.\n     *\n     * @param {HTMLElement} stepContentEl\n     * @param {Object} spriteConfig\n     */\n    const attachSprite = (stepContentEl, spriteConfig) => {\n        const stepContent = $(stepContentEl);\n        stepContent.addClass(CLASS_APPLIED);\n        stepContent.find(`.${SPRITE_CLASS}`).remove();\n\n        const sprite = document.createElement('div');\n        sprite.className = `${SPRITE_CLASS} ${SPRITE_CLASS}--${spriteConfig.variant}`;\n        sprite.style.backgroundImage = `url('${spriteConfig.url}')`;\n        stepContent.append(sprite);\n    };\n\n    /**\n     * Observe the document for tour steps and decorate them.\n     *\n     * @param {Object} spriteConfig\n     */\n    const watchForSteps = spriteConfig => {\n        const processedNodes = new WeakSet();\n        const decorate = node => {\n            if (processedNodes.has(node)) {\n                return;\n            }\n            processedNodes.add(node);\n            attachSprite(node, spriteConfig.nextVariant());\n        };\n\n        // Initial scan in case a step is already visible.\n        document.querySelectorAll(STEP_CONTAINER_SELECTOR).forEach(node => decorate(node));\n\n        const observer = new MutationObserver(mutations => {\n            try {\n                mutations.forEach(mutation => {\n                    mutation.addedNodes.forEach(node => {\n                        if (!(node instanceof HTMLElement)) {\n                            return;\n                        }\n\n                        if (isStepContainer(node)) {\n                            decorate(node);\n                            return;\n                        }\n\n                        const nested = node.querySelectorAll ? node.querySelectorAll(STEP_CONTAINER_SELECTOR) : [];\n                        nested.forEach(nestedNode => decorate(nestedNode));\n                    });\n                });\n            } catch (error) {\n                window.console.error('Adaptive course audit sprite observer error', error);\n            }\n        });\n\n        observer.observe(document.body, {\n            childList: true,\n            subtree: true,\n        });\n    };\n\n    /**\n     * Factory to provide alternating sprite variants.\n     *\n     * @param {string} talkSprite\n     * @param {string} winkSprite\n     * @returns {{nextVariant: function(): {variant: string, url: string}}}\n     */\n    const createSpriteConfig = (talkSprite, winkSprite) => {\n        const variants = [\n            {variant: 'talk', url: talkSprite},\n            {variant: 'wink', url: winkSprite},\n        ];\n        let index = 0;\n\n        return {\n            nextVariant: () => {\n                const choice = variants[index % variants.length];\n                index++;\n                return choice;\n            },\n        };\n    };\n\n    /**\n     * Entry point.\n     */\n    const buildDefaultConfig = () => {\n        const wwwroot = coreConfig && coreConfig.wwwroot ? coreConfig.wwwroot :\n        (window.M && window.M.cfg && window.M.cfg.wwwroot ? window.M.cfg.wwwroot : '');\n        if (!wwwroot) {\n            return null;\n        }\n        return {\n            talkSpriteUrl: `${wwwroot}/local/adaptive_course_audit/pix/miau_talk_sprite.png`,\n            winkSpriteUrl: `${wwwroot}/local/adaptive_course_audit/pix/miau_wink_sprite.png`,\n        };\n    };\n\n    const init = config => {\n        try {\n            const resolvedConfig = (config && config.talkSpriteUrl && config.winkSpriteUrl)\n                ? config\n                : buildDefaultConfig();\n            if (!resolvedConfig || !resolvedConfig.talkSpriteUrl || !resolvedConfig.winkSpriteUrl) {\n                window.console.error('Adaptive course audit sprites missing URLs');\n                return;\n            }\n\n            const spriteConfig = createSpriteConfig(resolvedConfig.talkSpriteUrl, resolvedConfig.winkSpriteUrl);\n            watchForSteps(spriteConfig);\n        } catch (error) {\n            window.console.error('Adaptive course audit sprite initialisation failed', error);\n        }\n    };\n\n    return {\n        init: init,\n    };\n});\n\n"],"names":["define","$","coreConfig","watchForSteps","spriteConfig","processedNodes","WeakSet","decorate","node","has","add","stepContentEl","stepContent","addClass","find","remove","sprite","document","createElement","className","variant","style","backgroundImage","url","append","attachSprite","nextVariant","querySelectorAll","forEach","MutationObserver","mutations","mutation","addedNodes","HTMLElement","matches","isStepContainer","nestedNode","error","window","console","observe","body","childList","subtree","init","config","resolvedConfig","talkSpriteUrl","winkSpriteUrl","wwwroot","M","cfg","buildDefaultConfig","talkSprite","winkSprite","variants","index","choice","length","createSpriteConfig"],"mappings":";;;;;;;AAsBAA,kDAAO,CAAC,SAAU,gBAAgB,SAASC,EAAGC,kBAuCpCC,cAAgBC,qBACZC,eAAiB,IAAIC,QACrBC,SAAWC,OACTH,eAAeI,IAAID,QAGvBH,eAAeK,IAAIF,MAtBN,EAACG,cAAeP,sBAC3BQ,YAAcX,EAAEU,eACtBC,YAAYC,SArBM,2BAsBlBD,YAAYE,gBArBK,0BAqBoBC,eAE/BC,OAASC,SAASC,cAAc,OACtCF,OAAOG,oBAxBU,oCAAA,qCAwBsCf,aAAagB,SACpEJ,OAAOK,MAAMC,+BAA0BlB,aAAamB,UACpDX,YAAYY,OAAOR,SAefS,CAAajB,KAAMJ,aAAasB,iBAIpCT,SAASU,iBA/CmB,+CA+CuBC,SAAQpB,MAAQD,SAASC,QAE3D,IAAIqB,kBAAiBC,gBAE9BA,UAAUF,SAAQG,WACdA,SAASC,WAAWJ,SAAQpB,YAClBA,gBAAgByB,uBA3ClBzB,CAAAA,MACbA,gBAAgByB,aAAezB,KAAK0B,QAXf,+CAyDRC,CAAgB3B,kBAChBD,SAASC,OAIEA,KAAKmB,iBAAmBnB,KAAKmB,iBA9DhC,+CA8D4E,IACjFC,SAAQQ,YAAc7B,SAAS6B,oBAGhD,MAAOC,OACLC,OAAOC,QAAQF,MAAM,8CAA+CA,WAInEG,QAAQvB,SAASwB,KAAM,CAC5BC,WAAW,EACXC,SAAS,WA2DV,CACHC,KAlBSC,mBAECC,eAAkBD,QAAUA,OAAOE,eAAiBF,OAAOG,cAC3DH,OAfa,YACjBI,QAAU/C,YAAcA,WAAW+C,QAAU/C,WAAW+C,QAC7DX,OAAOY,GAAKZ,OAAOY,EAAEC,KAAOb,OAAOY,EAAEC,IAAIF,QAAUX,OAAOY,EAAEC,IAAIF,QAAU,UACtEA,QAGE,CACHF,wBAAkBE,iEAClBD,wBAAkBC,kEAJX,MAYDG,OACDN,iBAAmBA,eAAeC,gBAAkBD,eAAeE,0BACpEV,OAAOC,QAAQF,MAAM,oDAInBjC,aAzCa,EAACiD,WAAYC,oBAC9BC,SAAW,CACb,CAACnC,QAAS,OAAQG,IAAK8B,YACvB,CAACjC,QAAS,OAAQG,IAAK+B,iBAEvBE,MAAQ,QAEL,CACH9B,YAAa,WACH+B,OAASF,SAASC,MAAQD,SAASG,eACzCF,QACOC,UA8BUE,CAAmBb,eAAeC,cAAeD,eAAeE,eACrF7C,cAAcC,cAChB,MAAOiC,OACLC,OAAOC,QAAQF,MAAM,qDAAsDA"}